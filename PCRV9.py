import streamlit as st
import matplotlib.pyplot as plt
import numpy as np
from Bio.SeqUtils import MeltingTemp as mt
from Bio.Seq import Seq
from Bio.Blast import NCBIWWW
from Bio.Blast import NCBIXML
import time

# è¨­å®šé é¢è³‡è¨Š
st.set_page_config(page_title="PCR å¼•å­æˆ°æƒ…å®¤", page_icon="ğŸ§¬", layout="wide")

# ================= æ ¸å¿ƒè¨ˆç®—é‚è¼¯ =================

def calculate_adjusted_tm(perfect_tm, identity_percent):
    """ä¼°ç®—ä¸å®Œç¾çµåˆæ™‚çš„ Tm å€¼"""
    mismatch_percent = 100 - identity_percent
    drop = mismatch_percent * 1.2 
    return perfect_tm - drop

def calculate_pcr_conditions(product_size, tm_f, tm_r, enzyme):
    tm_min = min(tm_f, tm_r)
    anneal_temp = tm_min - 3 
    if enzyme == "Taq":
        rate, name = 60, "General Taq"
    else:
        rate, name = 30, "High-Fidelity"
    ext_time = max(30, int((product_size / 1000) * rate))
    return name, anneal_temp, ext_time

# ä½¿ç”¨ Streamlit çš„å¿«å–åŠŸèƒ½ï¼Œé¿å…é‡è¤‡é€£ç·š NCBI
@st.cache_data(show_spinner=False)
def fetch_blast_data(f_seq, r_seq, organism, database):
    """é€£ç·š NCBI æŠ“å–è³‡æ–™ (æœƒè¢«å¿«å–)"""
    
    # 1. è¨ˆç®— Tm
    tm_f = mt.Tm_NN(Seq(f_seq.upper()))
    tm_r = mt.Tm_NN(Seq(r_seq.upper()))
    
    # 2. BLAST Forward
    rh_f = NCBIWWW.qblast("blastn", database, f_seq, entrez_query=f'"{organism}"[Organism]', expect=50000, word_size=7)
    rec_f = NCBIXML.read(rh_f)
    
    # 3. BLAST Reverse
    rh_r = NCBIWWW.qblast("blastn", database, r_seq, entrez_query=f'"{organism}"[Organism]', expect=50000, word_size=7)
    rec_r = NCBIXML.read(rh_r)
    
    # 4. è§£æè³‡æ–™
    parsed_f = []
    for a in rec_f.alignments:
        for h in a.hsps:
            ident = (h.identities / h.align_length) * 100
            parsed_f.append({'id': a.accession, 's': h.sbjct_start, 'str': h.frame[1], 't': a.title, 'ident': ident})
            
    parsed_r = []
    for a in rec_r.alignments:
        for h in a.hsps:
            ident = (h.identities / h.align_length) * 100
            parsed_r.append({'id': a.accession, 's': h.sbjct_start, 'str': h.frame[1], 't': a.title, 'ident': ident})
            
    return parsed_f, parsed_r, tm_f, tm_r

def draw_gel_plot(products, temp_val, organism):
    """ç¹ªè£½ Matplotlib åœ–è¡¨"""
    fig, ax = plt.subplots(figsize=(8, 5))
    ax.set_facecolor('black')
    
    # Marker
    ladder = [100, 200, 300, 400, 500, 600, 800, 1000, 1500, 2000, 3000]
    for b in ladder:
        y = -np.log10(b)
        ax.hlines(y, 0.5, 1.5, colors='white', alpha=0.5)
        ax.text(0.1, y, f"{b}", color='white', fontsize=8, va='center')

    # Products
    visible_count = 0
    for i, p in enumerate(products):
        size = p['size']
        y = -np.log10(size)
        
        is_target = (p['f_ident'] == 100 and p['r_ident'] == 100)
        
        if is_target:
            color, alpha, lw = '#00FF00', 1.0, 3.5
            label = f"{size}bp (Target)"
        else:
            color, alpha, lw = 'yellow', 0.6, 2
            label = f"{size}bp (Non-specific)"
            
        ax.hlines(y, 2.5, 3.5, colors=color, alpha=alpha, linewidth=lw)
        if visible_count < 6: # é¿å…å¤ªå¤šæ–‡å­—é‡ç–Š
            ax.text(3.7, y, label, color=color, fontsize=9, va='center')
        visible_count += 1

    ax.set_xlim(0, 5)
    ax.set_ylim(-np.log10(3500), -np.log10(80))
    ax.set_xticks([1, 3])
    ax.set_xticklabels(['Marker', f'PCR @ {temp_val}Â°C'])
    ax.set_yticks([])
    ax.set_title(f"In-Silico PCR Simulation: {organism}", color='white')
    plt.tight_layout()
    return fig

# ================= Streamlit ä»‹é¢ä½ˆå±€ =================

st.title("ğŸ§¬ PCR å¼•å­æˆ°æƒ…å®¤ (Streamlit Pro)")
st.markdown("å¯¦é©—å®¤å°ˆç”¨å¼•å­è¨­è¨ˆé©—è­‰èˆ‡ç†±æ¨¡æ“¬ç³»çµ±")

# Sidebar è¨­å®šå€
with st.sidebar:
    st.header("âš™ï¸ åƒæ•¸è¨­å®š")
    organism = st.selectbox("ç›®æ¨™ç‰©ç¨®", ["Homo sapiens", "Mus musculus", "Rattus norvegicus"])
    database = st.selectbox("è³‡æ–™åº«é¡å‹", ["refseq_rna", "nt"], index=0, help="mRNAç”¨ refseq_rna, gDNAç”¨ nt")
    enzyme = st.selectbox("é…µç´ é¡å‹", ["Taq", "High-Fidelity"])
    st.info("ğŸ’¡ æç¤ºï¼šè¼¸å…¥å¼•å­å¾ŒæŒ‰ã€Œé–‹å§‹åˆ†æã€ï¼Œå®Œæˆå¾Œå¯èª¿æ•´æº«åº¦æ»‘æ¡¿ã€‚")

# ä¸»è¦è¼¸å…¥å€
col1, col2 = st.columns(2)
with col1:
    f_seq = st.text_input("Forward Primer (5'->3')", placeholder="è¼¸å…¥åºåˆ—...").strip()
with col2:
    r_seq = st.text_input("Reverse Primer (5'->3')", placeholder="è¼¸å…¥åºåˆ—...").strip()

# åˆ†ææŒ‰éˆ•èˆ‡é‚è¼¯
if st.button("ğŸš€ é–‹å§‹åˆ†æ / æ›´æ–°è³‡æ–™", type="primary"):
    if not f_seq or not r_seq:
        st.error("âŒ è«‹è¼¸å…¥å®Œæ•´çš„ Fwd å’Œ Rev å¼•å­åºåˆ—ï¼")
    else:
        try:
            with st.spinner(f"æ­£åœ¨é€£ç·š NCBI è³‡æ–™åº«æ¯”å° {organism}... (é€™å¯èƒ½éœ€è¦ 1-2 åˆ†é˜)"):
                # å‘¼å«å¿«å–å‡½æ•¸
                data_f, data_r, tm_f, tm_r = fetch_blast_data(f_seq, r_seq, organism, database)
                
                # å°‡çµæœå­˜å…¥ Session State (è®“æ»‘æ¡¿äº’å‹•æ™‚ä¸ç”¨é‡è·‘)
                st.session_state['blast_result'] = {
                    'f': data_f, 'r': data_r, 
                    'tm_f': tm_f, 'tm_r': tm_r,
                    'done': True
                }
            st.success("âœ… åˆ†æå®Œæˆï¼è«‹æŸ¥çœ‹ä¸‹æ–¹æ¨¡æ“¬çµæœã€‚")
        except Exception as e:
            st.error(f"ç™¼ç”ŸéŒ¯èª¤: {e}")

# ================= çµæœé¡¯ç¤ºèˆ‡ç†±æ¨¡æ“¬å€ =================

if 'blast_result' in st.session_state and st.session_state['blast_result']['done']:
    res = st.session_state['blast_result']
    
    st.divider()
    st.subheader("ğŸ›ï¸ å‹•æ…‹ç†±æ¨¡æ“¬å¯¦é©—å®¤")
    
    # é¡¯ç¤ºåŸºç¤è³‡è¨Š
    c1, c2, c3 = st.columns(3)
    c1.metric("Fwd Tm", f"{res['tm_f']:.1f} Â°C")
    c2.metric("Rev Tm", f"{res['tm_r']:.1f} Â°C")
    
    # æº«åº¦æ»‘æ¡¿
    default_temp = min(res['tm_f'], res['tm_r']) - 5
    temp_val = st.slider("èª¿æ•´ Annealing æº«åº¦ (Â°C)", min_value=40.0, max_value=75.0, value=default_temp, step=0.5)
    
    # --- å³æ™‚è¨ˆç®—ç”¢ç‰© ---
    products = []
    f_hits = res['f']
    r_hits = res['r']
    
    for f in f_hits:
        hit_tm_f = calculate_adjusted_tm(res['tm_f'], f['ident'])
        if hit_tm_f < temp_val: continue # æº«åº¦éé«˜ï¼Œå¼•å­è„«è½

        for r in r_hits:
            if f['id'] == r['id'] and f['str'] != r['str']:
                hit_tm_r = calculate_adjusted_tm(res['tm_r'], r['ident'])
                if hit_tm_r < temp_val: continue # æº«åº¦éé«˜ï¼Œå¼•å­è„«è½
                
                dist = abs(r['s'] - f['s']) + 1
                if 50 < dist < 5000:
                    if not any(p['size'] == dist for p in products):
                        products.append({
                            'size': dist, 
                            'gene': f['t'],
                            'f_ident': f['ident'], 
                            'r_ident': r['ident']
                        })
    
    products.sort(key=lambda x: x['size'])
    
    # --- é¡¯ç¤ºçµæœ ---
    col_res, col_img = st.columns([1, 2])
    
    with col_res:
        st.markdown(f"**æ¨¡æ“¬çµæœ: ç™¼ç¾ {len(products)} æ¢ç”¢ç‰©**")
        if not products:
            st.warning("â„ï¸ æ­¤æº«åº¦ä¸‹ç„¡ç”¢ç‰© (å¼•å­ç„¡æ³•çµåˆ)")
        else:
            # æ‰¾å‡ºä¸»è¦ç”¢ç‰©çµ¦å»ºè­°
            target = products[0]
            if target['f_ident'] == 100 and target['r_ident'] == 100:
                st.success(f"âœ… ä¸»è¦ç”¢ç‰©: {target['size']} bp")
                enz_name, ann, ext = calculate_pcr_conditions(target['size'], res['tm_f'], res['tm_r'], enzyme)
                st.info(f"ğŸ§ª **å»ºè­°æ¢ä»¶ ({enz_name})**\n\n"
                        f"- Anneal: {ann:.1f}Â°C\n"
                        f"- Extension: {ext}s")
            else:
                st.warning("âš ï¸ ä¸»è¦ç”¢ç‰©ä¼¼ä¹éå®Œç¾çµåˆ")

            # åˆ—å‡ºæ‰€æœ‰ç”¢ç‰©
            with st.expander("æŸ¥çœ‹è©³ç´°ç”¢ç‰©åˆ—è¡¨", expanded=True):
                for p in products:
                    icon = "âœ…" if (p['f_ident']==100 and p['r_ident']==100) else "âš ï¸"
                    st.write(f"{icon} **{p['size']} bp** - {p['gene'][:30]}...")

    with col_img:
        if products:
            fig = draw_gel_plot(products, temp_val, organism)
            st.pyplot(fig)
